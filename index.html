<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ Ğ˜Ğ³Ñ€Ñ‹ â€” Ğ Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ³Ñ€</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:#0d0f1a;min-height:100vh;padding:30px 16px 60px;color:#e2e8f0;transition:background 0.3s,color 0.3s}
.container{max-width:1320px;margin:0 auto}

.header{text-align:center;margin-bottom:36px}
.title{font-family:'Unbounded',sans-serif;font-size:clamp(28px,5vw,52px);font-weight:900;background:linear-gradient(135deg,#60a5fa,#a78bfa,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.subtitle{font-size:15px;color:#94a3b8;margin-bottom:14px}
.meta-row{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
.update-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;background:rgba(255,255,255,0.06);border-radius:50px;color:#94a3b8;font-size:13px;border:1px solid rgba(255,255,255,0.08)}
.live-badge{padding:4px 12px;border-radius:8px;background:rgba(34,197,94,0.15);color:#4ade80;border:1px solid rgba(34,197,94,0.2);font-size:12px;font-weight:700}
.cache-badge{padding:4px 12px;border-radius:8px;background:rgba(251,191,36,0.12);color:#fbbf24;border:1px solid rgba(251,191,36,0.2);font-size:12px;font-weight:700}
.fallback-badge{padding:4px 12px;border-radius:8px;background:rgba(139,92,246,0.15);color:#a78bfa;border:1px solid rgba(139,92,246,0.2);font-size:12px;font-weight:700}

.controls{background:rgba(255,255,255,0.04);padding:20px;border-radius:16px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.06)}
.search-box{width:100%;padding:13px 18px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;font-size:15px;background:rgba(255,255,255,0.05);color:#e2e8f0;font-family:inherit;margin-bottom:14px;outline:none;transition:border-color 0.2s}
.search-box:focus{border-color:rgba(139,92,246,0.5)}
.search-box::placeholder{color:#64748b}
.filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.fbtn{padding:7px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#94a3b8;cursor:pointer;font-weight:700;font-size:13px;font-family:inherit;transition:all 0.2s}
.fbtn.on{background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:transparent;color:#fff}
.fbtn:hover:not(.on){background:rgba(255,255,255,0.08)}
.sort-row{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
.sort-btn{padding:5px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:6px;color:#64748b;cursor:pointer;font-weight:700;font-size:12px;font-family:inherit;transition:all 0.2s}
.sort-btn.on{color:#a78bfa;border-color:rgba(167,139,250,0.4)}

.tabs{display:flex;gap:8px;margin-bottom:28px;justify-content:center;flex-wrap:wrap}
.tab{padding:10px 22px;font-weight:800;font-size:14px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;cursor:pointer;font-family:inherit;transition:all 0.2s}
.tab.on{background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:transparent;color:#fff}

.tiny-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:-10px 0 18px}
.chk{display:inline-flex;gap:8px;align-items:center;color:#94a3b8;font-size:13px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;cursor:pointer}
.chk input{accent-color:#8b5cf6}

.stats{display:flex;justify-content:center;gap:12px;margin-bottom:32px;flex-wrap:wrap}
.stat-card{background:rgba(255,255,255,0.04);padding:16px 22px;border-radius:14px;text-align:center;border:1px solid rgba(255,255,255,0.06);min-width:90px}
.stat-card.value-card{border-color:rgba(34,197,94,0.12);background:rgba(34,197,94,0.04)}
.stat-card.savings-card{border-color:rgba(59,130,246,0.12);background:rgba(59,130,246,0.04)}
.stat-number{font-family:'Unbounded',sans-serif;font-size:26px;font-weight:900}
.stat-number.green{color:#4ade80}
.stat-number.blue{color:#60a5fa}
.stat-label{font-size:11px;color:#64748b;margin-top:4px;text-transform:uppercase;letter-spacing:0.06em;font-weight:700}
.stat-label.green{color:#16a34a}
.stat-label.blue{color:#3b82f6}

.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:40px}
.gc{background:#181b2e;border-radius:16px;overflow:hidden;transition:transform 0.25s,box-shadow 0.25s;border:1px solid rgba(255,255,255,0.06);position:relative;animation:fadeUp 0.5s ease-out backwards}
.gc:hover{transform:translateY(-6px);box-shadow:0 16px 48px rgba(99,102,241,0.15)}
.gc.expired-card{opacity:0.5;filter:grayscale(0.5)}

.take-btn{position:absolute;top:10px;right:10px;width:38px;height:38px;border-radius:50%;border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);cursor:pointer;z-index:5;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-weight:900;font-size:16px;transition:all 0.2s}
.take-btn:hover{transform:scale(1.12)}
.take-btn.on{background:rgba(34,197,94,0.22);border-color:rgba(34,197,94,0.35);color:#4ade80}

.gi{width:100%;height:180px;object-fit:cover;display:block;background:linear-gradient(135deg,#1e1b4b,#312e81)}
.gi-ph{width:100%;height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:rgba(255,255,255,0.6);text-align:center;padding:16px;gap:8px}
.gi-ph::before{content:'ğŸ®';font-size:36px;opacity:0.5}

.gc-body{padding:20px}
.gc-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px}
.gc-title{font-family:'Unbounded',sans-serif;font-size:15px;font-weight:700;color:#f1f5f9;line-height:1.3;flex:1}
.gc-badges{display:flex;flex-direction:column;gap:5px;align-items:flex-end;flex-shrink:0}

.badge{padding:3px 9px;border-radius:5px;font-size:10px;font-weight:800;text-transform:uppercase;white-space:nowrap}
.b-epic{background:rgba(59,130,246,0.15);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.b-steam{background:rgba(99,102,241,0.12);color:#a5b4fc;border:1px solid rgba(99,102,241,0.2)}
.b-gog{background:rgba(168,85,247,0.12);color:#c084fc;border:1px solid rgba(168,85,247,0.2)}
.b-itchio{background:rgba(245,101,101,0.12);color:#fca5a5;border:1px solid rgba(245,101,101,0.2)}
.b-other{background:rgba(148,163,184,0.12);color:#94a3b8;border:1px solid rgba(148,163,184,0.2)}
.b-hot{background:rgba(239,68,68,0.15);color:#fca5a5;border:1px solid rgba(239,68,68,0.25)}
.b-val{background:rgba(34,197,94,0.10);color:#4ade80;border:1px solid rgba(34,197,94,0.18);font-size:9px}
.b-taken{background:rgba(34,197,94,0.16);color:#4ade80;border:1px solid rgba(34,197,94,0.26)}
.b-new{background:rgba(251,191,36,0.15);color:#fbbf24;border:1px solid rgba(251,191,36,0.25);animation:pulse 2s infinite}
.b-expired{background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.2)}
.b-verified{background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.2)}

.gc-desc{color:#64748b;font-size:13px;line-height:1.5;margin-bottom:16px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cd{background:rgba(239,68,68,0.08);padding:8px 12px;border-radius:8px;margin-bottom:14px;text-align:center;border:1px solid rgba(239,68,68,0.12)}
.cd-t{font-size:11px;color:#f87171;font-weight:700}
.cd-v{font-size:15px;font-weight:900;color:#f87171;margin-top:3px;font-family:'Unbounded',sans-serif}
.cd-expired{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.25)}
.cd-expired .cd-t,.cd-expired .cd-v{color:#ef4444}

.gc-foot{display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06);gap:12px}
.p-free{font-family:'Unbounded',sans-serif;font-size:18px;font-weight:900;background:linear-gradient(135deg,#4ade80,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.gc-link{padding:9px 20px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;text-decoration:none;border-radius:10px;font-weight:800;font-size:13px;transition:all 0.2s;white-space:nowrap}
.gc-link:hover{transform:scale(1.04);box-shadow:0 8px 24px rgba(99,102,241,0.35)}
.gc-link.disabled{opacity:0.5;pointer-events:none;background:#475569}

.empty{text-align:center;padding:40px 20px;color:#64748b;font-size:15px}
.src{text-align:center;padding:20px;color:#475569;font-size:12px}
.src a{color:#6366f1;text-decoration:none}

/* Loading skeleton */
.skeleton-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:40px}
.skeleton-card{background:#181b2e;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
.skeleton-img{width:100%;height:180px;background:linear-gradient(90deg,#1e1b4b 25%,#2d2a5e 50%,#1e1b4b 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
.skeleton-body{padding:20px}
.skeleton-line{height:14px;border-radius:7px;background:linear-gradient(90deg,rgba(255,255,255,0.05) 25%,rgba(255,255,255,0.1) 50%,rgba(255,255,255,0.05) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;margin-bottom:10px}
.skeleton-line.w60{width:60%}
.skeleton-line.w80{width:80%}
.skeleton-line.w40{width:40%}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Export/Import panel */
.toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
.tool-btn{padding:7px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#94a3b8;cursor:pointer;font-weight:700;font-size:12px;font-family:inherit;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.tool-btn:hover{background:rgba(255,255,255,0.08);color:#e2e8f0}
.tool-btn.success{background:rgba(34,197,94,0.15);border-color:rgba(34,197,94,0.3);color:#4ade80}

/* Toast notification */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:#1e293b;color:#e2e8f0;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:700;border:1px solid rgba(255,255,255,0.1);z-index:1000;transition:transform 0.3s ease;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.toast-success{border-color:rgba(34,197,94,0.3);background:rgba(34,197,94,0.15)}
.toast.toast-error{border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.15)}
.toast.toast-info{border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.15)}

/* Not free warning */
.not-free-warning{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:6px 10px;margin-bottom:14px;text-align:center;font-size:11px;color:#f87171;font-weight:700}

@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
@media(max-width:640px){body{padding:20px 10px 40px}.games-grid,.skeleton-grid{grid-template-columns:1fr;gap:16px}}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="title">Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ Ğ˜Ğ³Ñ€Ñ‹</h1>
    <p class="subtitle">Ğ Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ¸ Ñ€Ğ°Ğ½ĞµĞµ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€ â€” Ğ·Ğ°Ğ±ĞµÑ€Ğ¸ Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°</p>
    <div class="meta-row">
      <span class="update-badge">ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: <span id="fg-ut"></span></span>
      <span class="live-badge" id="fg-live" style="display:none">âœ… LIVE</span>
      <span class="cache-badge" id="fg-cache" style="display:none">ğŸ“¦ Ğ¸Ğ· ĞºÑÑˆĞ°</span>
      <span class="fallback-badge" id="fg-fallback" style="display:none">ğŸ’¾ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</span>
    </div>
  </div>

  <div class="controls">
    <input type="text" class="search-box" id="fg-sb" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ..." />
    <div class="filters" id="fg-fb"></div>
    <div class="sort-row">
      <button class="sort-btn on" data-sort="date">ĞĞ¾Ğ²Ñ‹Ğµ</button>
      <button class="sort-btn" data-sort="value">ĞŸĞ¾ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸</button>
      <button class="sort-btn" data-sort="az">Ğ-Ğ¯</button>
      <button class="sort-btn" data-sort="ending">Ğ¡ĞºĞ¾Ñ€Ğ¾ ĞºĞ¾Ğ½Ñ‡Ğ°Ñ‚ÑÑ</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab on" data-t="all">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ</button>
    <button class="tab" data-t="taken">Ğ—Ğ°Ğ±Ñ€Ğ°Ğ½Ğ¾ (<span id="fg-tc">0</span>)</button>
    <button class="tab" data-t="expired">Ğ˜ÑÑ‚Ñ‘ĞºÑˆĞ¸Ğµ</button>
  </div>

  <div class="tiny-row">
    <label class="chk">
      <input type="checkbox" id="fg-hideTaken">
      Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Â«ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹ĞµÂ»
    </label>
  </div>

  <div class="toolbar">
    <button class="tool-btn" id="fg-export" title="Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ…">ğŸ“¤ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚</button>
    <button class="tool-btn" id="fg-import" title="Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ…">ğŸ“¥ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚</button>
    <button class="tool-btn" id="fg-clear-taken" title="ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ…">ğŸ—‘ï¸ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>
  </div>

  <div class="stats" id="fg-st"></div>
  <div id="fg-ct"></div>

  <div class="src">
    Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ: <a href="https://www.gamerpower.com" target="_blank" rel="noopener">GamerPower</a> Â·
    <a href="https://store.epicgames.com/ru/free-games" target="_blank" rel="noopener">Epic Games</a> Â·
    <a href="https://www.gog.com" target="_blank" rel="noopener">GOG</a>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="fg-toast"></div>

<!-- Hidden file input for import -->
<input type="file" id="fg-file-input" accept=".json" style="display:none">

<script>
(function(){
  'use strict';

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FALLBACK DATA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  var FALLBACK = [
    {
      id:'fb-nwtd',
      title:'Nobody Wants to Die',
      desc:'ĞÑƒĞ°Ñ€Ğ½Ñ‹Ğ¹ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¸Ğ² Ğ² ĞÑŒÑ-Ğ™Ğ¾Ñ€ĞºĞµ 2329 Ğ³Ğ¾Ğ´Ğ°. Ğ Ğ°ÑÑĞ»ĞµĞ´ÑƒĞ¹ ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²Ğ° Ğ² Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğµ, Ğ³Ğ´Ğµ ÑĞ¼ĞµÑ€Ñ‚ÑŒ Ğ¿Ğ¾Ğ±ĞµĞ¶Ğ´ĞµĞ½Ğ°.',
      img:'https://www.gamerpower.com/offers/1/67a7e9e5e0338.jpg',
      url:'https://store.epicgames.com/ru/p/nobody-wants-to-die-a09dd1',
      end:'2026-02-20T16:00:00.000Z',
      store:'epic',worth:29.99,hot:true
    },
    {
      id:'fb-dd2',
      title:'The Darkside Detective: A Fumble in the Dark',
      desc:'ĞŸĞ¸ĞºÑĞµĞ»ÑŒĞ½Ñ‹Ğ¹ point-and-click Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¸Ğ². Ğ Ğ°ÑÑĞ»ĞµĞ´ÑƒĞ¹ Ğ¿Ğ°Ñ€Ğ°Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¸ Ğ² Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ Ğ¢Ğ²Ğ¸Ğ½ Ğ›ÑĞ¹ĞºÑ.',
      img:'https://www.gamerpower.com/offers/1/67a7ea3a7b80b.jpg',
      url:'https://store.epicgames.com/ru/p/the-darkside-detective-a-fumble-in-the-dark-4967f3',
      end:'2026-02-20T16:00:00.000Z',
      store:'epic',worth:17.99,hot:true
    },
    {
      id:'fb-aitd',
      title:'Alone in the Dark: The Trilogy 1+2+3',
      desc:'ĞšĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ‚Ñ€Ğ¸Ğ»Ğ¾Ğ³Ğ¸Ñ survival-Ñ…Ğ¾Ñ€Ñ€Ğ¾Ñ€Ğ¾Ğ² 1992-1995. Ğ¢Ñ€Ğ¸ ĞºÑƒĞ»ÑŒÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹.',
      img:'https://www.gamerpower.com/offers/1/679a1a6acbf56.jpg',
      url:'https://www.gog.com/en/game/alone_in_the_dark_the_trilogy_123',
      end:null,
      store:'gog',worth:5.99,hot:false
    },
    {
      id:'fb-encased',
      title:'Encased: A Sci-Fi Post-Apocalyptic RPG',
      desc:'Ğ˜Ğ·Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡ĞµÑĞºĞ°Ñ sci-fi RPG Ğ² Ğ´ÑƒÑ…Ğµ Fallout. Ğ˜ÑÑĞ»ĞµĞ´ÑƒĞ¹ Ñ‚Ğ°Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ ĞšÑƒĞ¿Ğ¾Ğ».',
      img:'https://www.gamerpower.com/offers/1/6784e75946a76.jpg',
      url:'https://store.steampowered.com/app/921800/Encased_A_SciFi_PostApocalyptic_RPG/',
      end:null,
      store:'steam',worth:29.99,hot:true
    }
  ];

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BLACKLIST â€” Ğ¸Ğ³Ñ€Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ĞĞ• Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ
     ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ² Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ÑÑ… Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  var TITLE_BLACKLIST = [
    'demo', 'trial', 'beta', 'alpha', 'playtest',
    'starter pack', 'starter edition',
    'free to play', 'free-to-play', 'f2p',
    'dlc', 'expansion', 'season pass', 'battle pass',
    'soundtrack', 'artbook', 'art book', 'wallpaper',
    'bonus content', 'cosmetic', 'skin pack',
    'in-game', 'virtual currency', 'coin', 'gems',
    'loot box', 'loot crate', 'mystery box',
    'coupon', 'discount', 'voucher', '% off'
  ];

  /* Ğ˜Ğ³Ñ€Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾ free-to-play (Ğ½Ğµ Ñ€Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ°) */
  var F2P_BLACKLIST = [
    'fortnite', 'apex legends', 'warframe', 'dota 2', 'dota2',
    'league of legends', 'valorant', 'genshin impact',
    'counter-strike', 'cs2', 'csgo', 'cs:go',
    'team fortress 2', 'tf2', 'path of exile', 'poe',
    'destiny 2', 'lost ark', 'world of tanks',
    'war thunder', 'world of warships', 'hearthstone',
    'rocket league', 'fall guys', 'multiversus',
    'the finals', 'xdefiant', 'overwatch 2',
    'palworld', 'honkai', 'star rail', 'zenless zone zero'
  ];

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  var games = [];
  var tab = 'all';
  var filt = 'all';
  var sort = 'date';
  var taken = {};    // { id: { ts: timestamp, worth: number } }
  var loading = true;
  var dataSource = 'none';

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STORAGE â€” localStorage + cookie backup
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function setCookie(name, val, days) {
    var d = new Date();
    d.setTime(d.getTime() + (days || 365) * 86400000);
    document.cookie = name + '=' + encodeURIComponent(val) + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
  }

  function getCookie(name) {
    var n = name + '=';
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i].trim();
      if (c.indexOf(n) === 0) return decodeURIComponent(c.substring(n.length));
    }
    return null;
  }

  function loadTaken() {
    try {
      var raw = localStorage.getItem('fgtaken2');
      if (raw) { taken = JSON.parse(raw); return; }
    } catch(e) {}
    // Fallback: try cookie
    try {
      var ck = getCookie('fgtaken2');
      if (ck) { taken = JSON.parse(ck); return; }
    } catch(e) {}
    // Migrate from old format (array of ids)
    try {
      var old = JSON.parse(localStorage.getItem('fgtaken') || '[]');
      if (Array.isArray(old) && old.length > 0) {
        taken = {};
        old.forEach(function(id) { taken[id] = { ts: Date.now(), worth: 0 }; });
        saveTaken();
        return;
      }
    } catch(e) {}
    taken = {};
  }

  function saveTaken() {
    var json = JSON.stringify(taken);
    try { localStorage.setItem('fgtaken2', json); } catch(e) {}
    // Backup to cookie (max ~4KB, truncate if needed)
    try {
      if (json.length < 3500) setCookie('fgtaken2', json, 365);
    } catch(e) {}
  }

  function loadPrefs() {
    try {
      var p = JSON.parse(localStorage.getItem('fgprefs') || '{}');
      if (p.sort) sort = p.sort;
      if (p.hideTaken) $('fg-hideTaken').checked = true;
    } catch(e) {}
  }

  function savePrefs() {
    try {
      localStorage.setItem('fgprefs', JSON.stringify({
        sort: sort,
        hideTaken: $('fg-hideTaken').checked
      }));
    } catch(e) {}
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DOM HELPERS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function $(id) { return document.getElementById(id); }
  function esc(s) { var d = document.createElement('div'); d.textContent = String(s || ''); return d.innerHTML; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST NOTIFICATIONS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  var toastTimer = null;
  function showToast(msg, type) {
    var t = $('fg-toast');
    t.textContent = msg;
    t.className = 'toast show' + (type ? ' toast-' + type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { t.classList.remove('show'); }, 3000);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FETCH with timeout + CORS proxy fallback
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function fetchWithTimeout(url, ms) {
    return new Promise(function(ok, no) {
      var c = new AbortController();
      var t = setTimeout(function() { c.abort(); }, ms || 10000);
      fetch(url, { signal: c.signal })
        .then(function(r) { clearTimeout(t); if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(ok)
        .catch(function(e) { clearTimeout(t); no(e); });
    });
  }

  function smartFetch(url, ms) {
    return fetchWithTimeout(url, ms || 10000).catch(function() {
      return fetchWithTimeout('https://api.allorigins.win/raw?url=' + encodeURIComponent(url), 12000);
    }).catch(function() {
      return fetchWithTimeout('https://corsproxy.io/?' + encodeURIComponent(url), 12000);
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CACHE (30 min)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  var CK = 'fgcache7';
  var CTL = 30 * 60 * 1000;

  function cacheGet() {
    try {
      var r = JSON.parse(localStorage.getItem(CK));
      if (r && Date.now() - r.ts < CTL) return r.data;
      return null;
    } catch(e) { return null; }
  }

  function cacheSet(d) {
    try { localStorage.setItem(CK, JSON.stringify({ ts: Date.now(), data: d })); } catch(e) {}
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VERIFY: Is game ACTUALLY free?
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function isActuallyFree(g) {
    var t = (g.title || '').toLowerCase();
    var d = (g.desc || '').toLowerCase();
    var combined = t + ' ' + d;

    // Check blacklisted words in title
    for (var i = 0; i < TITLE_BLACKLIST.length; i++) {
      if (t.indexOf(TITLE_BLACKLIST[i]) >= 0) return false;
    }

    // Check if it's an always-free game (not a giveaway)
    for (var j = 0; j < F2P_BLACKLIST.length; j++) {
      if (t.indexOf(F2P_BLACKLIST[j]) >= 0) return false;
    }

    // Must have a valid type â€” reject DLC, loot, early access demos
    if (g._rawType) {
      var rt = g._rawType.toLowerCase();
      if (rt.indexOf('dlc') >= 0 || rt.indexOf('loot') >= 0 || rt.indexOf('early') >= 0) return false;
    }

    // If status from API is not Active, skip
    if (g._rawStatus && g._rawStatus !== 'Active') return false;

    // If worth is exactly 0 and no end date â€” might be always free, be cautious
    // But allow if from known giveaway sources
    if (g.worth === 0 && !g.end && g.store === 'other') return false;

    return true;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NORMALIZE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function norm(g) {
    return {
      id: g.id || '',
      title: g.title || '',
      desc: g.desc || '',
      img: g.img || '',
      url: g.url || '#',
      end: g.end || null,
      store: g.store || 'other',
      worth: g.worth || 0,
      hot: !!g.hot,
      ts: g.ts || Date.now(),
      verified: !!g.verified,
      _rawType: g._rawType || '',
      _rawStatus: g._rawStatus || ''
    };
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     API: GamerPower
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function mapStore(p) {
    p = (p || '').toLowerCase();
    if (p.indexOf('epic') >= 0) return 'epic';
    if (p.indexOf('steam') >= 0) return 'steam';
    if (p.indexOf('gog') >= 0) return 'gog';
    if (p.indexOf('itch') >= 0) return 'itchio';
    return 'other';
  }

  function fetchGP() {
    return smartFetch('https://www.gamerpower.com/api/giveaways?type=game&sort-by=value', 10000).then(function(d) {
      if (!Array.isArray(d)) return [];
      return d.filter(function(g) {
        var p = (g.platforms || '').toLowerCase();
        return p.indexOf('pc') >= 0 || p.indexOf('steam') >= 0 || p.indexOf('epic') >= 0 || p.indexOf('gog') >= 0 || p.indexOf('itch') >= 0 || p.indexOf('drm') >= 0;
      }).map(function(g) {
        var w = 0;
        try { w = parseFloat(String(g.worth || '0').replace(/[^0-9.]/g, '')) || 0; } catch(e) {}
        return norm({
          id: 'gp-' + g.id,
          title: g.title,
          desc: g.description || g.short_description || '',
          img: g.thumbnail || g.image || '',
          url: g.open_giveaway_url || g.gamerpower_url || '#',
          end: (g.end_date && g.end_date !== 'N/A') ? g.end_date : null,
          store: mapStore(g.platforms),
          worth: w,
          hot: w > 15,
          ts: Date.now(),
          verified: true,
          _rawType: g.type || '',
          _rawStatus: g.status || ''
        });
      }).filter(function(g) { return g.title && isActuallyFree(g); });
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     API: Epic Games Store
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function fetchEpic() {
    return smartFetch('https://store-site-backend-static-ipv4.ak.epicgames.com/freeGamesPromotions?locale=en-US&country=US&allowCountries=US', 10000).then(function(data) {
      var el = (data && data.data && data.data.Catalog && data.data.Catalog.searchStore && data.data.Catalog.searchStore.elements) || [];
      var out = [];
      for (var i = 0; i < el.length; i++) {
        var g = el[i];
        if (!g.promotions) continue;
        var off = g.promotions.promotionalOffers || [];
        if (!off.length || !off[0].promotionalOffers || !off[0].promotionalOffers.length) continue;
        var o = off[0].promotionalOffers[0];

        // âœ… VERIFY: check discount is actually 100% (0 final price)
        var discountPct = 0;
        try { discountPct = o.discountSetting && o.discountSetting.discountPercentage; } catch(e) {}
        if (discountPct !== 0) continue; // 0 means free in Epic's API (confusing but true)

        var currentPrice = 0;
        try { currentPrice = g.price.totalPrice.discountPrice; } catch(e) { currentPrice = -1; }
        if (currentPrice !== 0) continue; // Must be exactly 0

        var img = '';
        var ki = g.keyImages || [];
        var preferred = ['DieselStoreFrontWide', 'OfferImageWide', 'DieselStoreFrontTall', 'OfferImageTall', 'Thumbnail', 'DieselGameBoxWide'];
        for (var p = 0; p < preferred.length; p++) {
          for (var j = 0; j < ki.length; j++) {
            if (ki[j].type === preferred[p]) { img = ki[j].url; break; }
          }
          if (img) break;
        }
        if (!img && ki.length) img = ki[0].url;

        var sl = g.productSlug || g.urlSlug || (g.offerMappings && g.offerMappings[0] && g.offerMappings[0].pageSlug) || '';
        var w = 0;
        try { var pr = g.price && g.price.totalPrice; if (pr && pr.originalPrice) w = pr.originalPrice / 100; } catch(e) {}

        var game = norm({
          id: 'ep-' + g.id,
          title: g.title || '',
          desc: g.description || 'Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ Ğ² Epic Games Store',
          img: img,
          url: sl ? 'https://store.epicgames.com/ru/p/' + sl : 'https://store.epicgames.com/ru/free-games',
          end: o.endDate,
          store: 'epic',
          worth: w,
          hot: true,
          ts: Date.now(),
          verified: true,
          _rawType: 'game',
          _rawStatus: 'Active'
        });

        if (isActuallyFree(game)) out.push(game);
      }
      return out;
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MERGE without duplicates
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function mergeGames() {
    var args = [].slice.call(arguments);
    var seen = {};
    var out = [];
    args.forEach(function(arr) {
      if (!Array.isArray(arr)) return;
      arr.forEach(function(g) {
        var key = g.title.toLowerCase().replace(/[^a-zĞ°-ÑÑ‘0-9]/g, '');
        if (!seen[key]) { seen[key] = true; out.push(g); }
      });
    });
    return out;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAKEN (claimed games)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function isTaken(id) { return !!taken[id]; }

  function toggleTaken(id) {
    if (taken[id]) {
      delete taken[id];
      showToast('Ğ£Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ· Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ…', 'info');
    } else {
      var game = games.find(function(g) { return g.id === id; });
      taken[id] = { ts: Date.now(), worth: game ? game.worth : 0 };
      showToast('âœ“ ĞÑ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ ĞºĞ°Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ!', 'success');
    }
    saveTaken();
    updateTakenCount();
    render();
  }
  window._fgToggleTaken = toggleTaken;

  function updateTakenCount() {
    $('fg-tc').textContent = Object.keys(taken).length;
  }

  function getTakenSavings() {
    var total = 0;
    Object.keys(taken).forEach(function(id) {
      var w = taken[id].worth || 0;
      if (w > 0) total += w;
      else {
        // Try to find worth from current games list
        var game = games.find(function(g) { return g.id === id; });
        if (game && game.worth > 0) total += game.worth;
      }
    });
    return total;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EXPORT / IMPORT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function exportTaken() {
    var data = {
      version: 2,
      exported: new Date().toISOString(),
      taken: taken,
      count: Object.keys(taken).length
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'free-games-backup-' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('ğŸ“¤ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ ' + Object.keys(taken).length + ' Ğ¸Ğ³Ñ€', 'success');
  }

  function importTaken(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (data.taken && typeof data.taken === 'object') {
          // Merge with existing
          Object.keys(data.taken).forEach(function(id) {
            if (!taken[id]) taken[id] = data.taken[id];
          });
          saveTaken();
          updateTakenCount();
          render();
          showToast('ğŸ“¥ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾! Ğ’ÑĞµĞ³Ğ¾: ' + Object.keys(taken).length + ' Ğ¸Ğ³Ñ€', 'success');
        } else if (Array.isArray(data)) {
          // Old format (array of ids)
          data.forEach(function(id) {
            if (!taken[id]) taken[id] = { ts: Date.now(), worth: 0 };
          });
          saveTaken();
          updateTakenCount();
          render();
          showToast('ğŸ“¥ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°!', 'success');
        } else {
          showToast('âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ°', 'error');
        }
      } catch(err) {
        showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°', 'error');
      }
    };
    reader.readAsText(file);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COUNTDOWN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function countdown(end) {
    if (!end) return null;
    try {
      var d = new Date(end).getTime() - Date.now();
      if (d < 0) return { expired: true, text: 'Ğ Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ' };
      var days = Math.floor(d / 864e5);
      var hrs = Math.floor((d % 864e5) / 36e5);
      var mins = Math.floor((d % 36e5) / 6e4);
      return { expired: false, text: days + 'Ğ´ ' + hrs + 'Ñ‡ ' + mins + 'Ğ¼' };
    } catch(e) { return null; }
  }

  function isNew(g) {
    // Game added in last 48 hours
    return g.ts && (Date.now() - g.ts < 48 * 3600 * 1000);
  }

  function isExpired(g) {
    if (!g.end) return false;
    return new Date(g.end).getTime() < Date.now();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SORT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function sortGames(arr) {
    var c = arr.slice();
    if (sort === 'value') c.sort(function(a, b) { return (b.worth || 0) - (a.worth || 0); });
    else if (sort === 'az') c.sort(function(a, b) { return a.title.localeCompare(b.title); });
    else if (sort === 'ending') c.sort(function(a, b) {
      var ae = a.end ? new Date(a.end).getTime() : Infinity;
      var be = b.end ? new Date(b.end).getTime() : Infinity;
      return ae - be;
    });
    return c;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     IMAGE ERROR HANDLER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function imgError(el) {
    el.style.display = 'none';
    var ph = el.nextElementSibling;
    if (ph) ph.style.display = 'flex';
  }
  window._fgImgError = imgError;

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SKELETON LOADING
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function skeletonHTML() {
    var h = '<div class="skeleton-grid">';
    for (var i = 0; i < 6; i++) {
      h += '<div class="skeleton-card">' +
        '<div class="skeleton-img"></div>' +
        '<div class="skeleton-body">' +
          '<div class="skeleton-line w80"></div>' +
          '<div class="skeleton-line w60"></div>' +
          '<div class="skeleton-line w40"></div>' +
        '</div>' +
      '</div>';
    }
    h += '</div>';
    return h;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARD HTML
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function cardHTML(g, i) {
    var tkn = isTaken(g.id);
    var cd = countdown(g.end);
    var expired = isExpired(g);

    var gr = 'linear-gradient(135deg,#1e1b4b,#312e81)';
    if (g.store === 'epic') gr = 'linear-gradient(135deg,#1a1a2e,#16213e)';
    if (g.store === 'gog') gr = 'linear-gradient(135deg,#1a0a2e,#2d1b69)';
    if (g.store === 'steam') gr = 'linear-gradient(135deg,#1b2838,#2a475e)';
    if (g.store === 'itchio') gr = 'linear-gradient(135deg,#2e1a1a,#691b1b)';

    var imgH = '';
    if (g.img) {
      imgH =
        '<img src="' + esc(g.img) + '" class="gi" alt="' + esc(g.title) + '" loading="lazy" decoding="async" referrerpolicy="no-referrer" onerror="_fgImgError(this)">' +
        '<div class="gi-ph" style="display:none;background:' + gr + '">' + esc(g.title) + '</div>';
    } else {
      imgH = '<div class="gi-ph" style="background:' + gr + '">' + esc(g.title) + '</div>';
    }

    var badges = '';
    if (g.verified) badges += '<span class="badge b-verified">âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾</span>';
    badges += '<span class="badge b-' + (g.store || 'other') + '">' + (g.store || 'other').toUpperCase() + '</span>';
    if (g.worth > 0) badges += '<span class="badge b-val">$' + (g.worth || 0).toFixed(0) + ' value</span>';
    if (isNew(g)) badges += '<span class="badge b-new">ğŸ†• NEW</span>';
    if (g.hot && !expired) badges += '<span class="badge b-hot">ğŸ”¥ HOT</span>';
    if (expired) badges += '<span class="badge b-expired">â° Ğ˜Ğ¡Ğ¢Ğ•ĞšĞ›Ğ</span>';
    if (tkn) badges += '<span class="badge b-taken">âœ“ Ğ—ĞĞ‘Ğ ĞĞĞ</span>';

    var cdHTML = '';
    if (cd) {
      if (cd.expired) {
        cdHTML = '<div class="cd cd-expired"><div class="cd-t">â° Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</div><div class="cd-v">' + cd.text + '</div></div>';
      } else {
        cdHTML = '<div class="cd"><div class="cd-t">â° ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ:</div><div class="cd-v">' + cd.text + '</div></div>';
      }
    }

    var linkClass = 'gc-link' + (expired ? ' disabled' : '');
    var linkText = expired ? 'Ğ—Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ' : 'Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ â†’';

    return '' +
    '<div class="gc' + (expired ? ' expired-card' : '') + '" style="animation-delay:' + (i * 0.04) + 's">' +
      '<button class="take-btn ' + (tkn ? 'on' : '') + '" title="' + (tkn ? 'Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ…' : 'ĞŸĞ¾Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ') + '" onclick="_fgToggleTaken(\'' + g.id + '\')">' + (tkn ? 'âœ“' : 'ï¼‹') + '</button>' +
      imgH +
      '<div class="gc-body">' +
        '<div class="gc-head">' +
          '<h3 class="gc-title">' + esc(g.title) + '</h3>' +
          '<div class="gc-badges">' + badges + '</div>' +
        '</div>' +
        '<p class="gc-desc">' + esc(g.desc) + '</p>' +
        cdHTML +
        '<div class="gc-foot">' +
          '<div class="p-free">Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾</div>' +
          '<a href="' + esc(g.url) + '" target="_blank" rel="noopener" class="' + linkClass + '">' + linkText + '</a>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RENDER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function render() {
    var el = $('fg-ct');
    var q = ($('fg-sb').value || '').toLowerCase();

    // Split by expired/active
    var active = games.filter(function(g) { return !isExpired(g); });
    var expiredGames = games.filter(function(g) { return isExpired(g); });

    var list;
    if (tab === 'taken') {
      list = games.filter(function(g) { return isTaken(g.id); });
    } else if (tab === 'expired') {
      list = expiredGames;
    } else {
      list = active.slice();
      if ($('fg-hideTaken').checked) {
        list = list.filter(function(g) { return !isTaken(g.id); });
      }
    }

    if (q) list = list.filter(function(g) { return g.title.toLowerCase().indexOf(q) >= 0; });
    if (filt !== 'all') list = list.filter(function(g) { return g.store === filt; });
    list = sortGames(list);

    // Store filters
    var sourceList = (tab === 'expired') ? expiredGames : active;
    var stores = [];
    sourceList.forEach(function(g) { if (stores.indexOf(g.store) < 0) stores.push(g.store); });
    var fh = '<button class="fbtn ' + (filt === 'all' ? 'on' : '') + '" data-filt="all">Ğ’ÑĞµ</button>';
    stores.forEach(function(s) {
      fh += '<button class="fbtn ' + (filt === s ? 'on' : '') + '" data-filt="' + s + '">' + s.toUpperCase() + '</button>';
    });
    $('fg-fb').innerHTML = fh;

    // Sort highlighting
    document.querySelectorAll('.sort-btn').forEach(function(b) {
      b.classList.toggle('on', b.getAttribute('data-sort') === sort);
    });

    // Stats
    var sc = {};
    var totalValue = 0;
    list.forEach(function(g) {
      sc[g.store] = (sc[g.store] || 0) + 1;
      totalValue += (g.worth || 0);
    });
    var sh = '';
    Object.keys(sc).forEach(function(k) {
      sh += '<div class="stat-card"><div class="stat-number">' + sc[k] + '</div><div class="stat-label">' + k.toUpperCase() + '</div></div>';
    });
    sh += '<div class="stat-card"><div class="stat-number">' + list.length + '</div><div class="stat-label">Ğ’ÑĞµĞ³Ğ¾</div></div>';
    if (totalValue > 0) {
      sh += '<div class="stat-card value-card"><div class="stat-number green">$' + totalValue.toFixed(0) + '</div><div class="stat-label green">Ğ¦ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ</div></div>';
    }
    // Savings from taken games
    var savings = getTakenSavings();
    if (savings > 0) {
      sh += '<div class="stat-card savings-card"><div class="stat-number blue">$' + savings.toFixed(0) + '</div><div class="stat-label blue">ğŸ’° Ğ¢Ñ‹ ÑÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ»</div></div>';
    }
    $('fg-st').innerHTML = sh;

    // Cards
    if (list.length) {
      el.innerHTML = '<div class="games-grid">' + list.map(cardHTML).join('') + '</div>';
    } else {
      var emptyMsg = 'ğŸ” ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾';
      if (tab === 'taken') emptyMsg = 'ğŸ“‹ ĞŸĞ¾ĞºĞ° Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ ĞºĞ°Ğº Â«Ğ—Ğ°Ğ±Ñ€Ğ°Ğ½Ğ¾Â»';
      if (tab === 'expired') emptyMsg = 'ğŸ“¦ ĞĞµÑ‚ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ñ… Ñ€Ğ°Ğ·Ğ´Ğ°Ñ‡';
      el.innerHTML = '<div class="empty">' + emptyMsg + '</div>';
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BADGES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function showBadge(src) {
    dataSource = src;
    $('fg-live').style.display = (src === 'live') ? 'inline-block' : 'none';
    $('fg-cache').style.display = (src === 'cache') ? 'inline-block' : 'none';
    $('fg-fallback').style.display = (src === 'fallback') ? 'inline-block' : 'none';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVENT HANDLERS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('.fbtn[data-filt]');
    if (btn) { filt = btn.getAttribute('data-filt'); render(); return; }

    var sortBtn = e.target.closest('.sort-btn[data-sort]');
    if (sortBtn) { sort = sortBtn.getAttribute('data-sort'); savePrefs(); render(); return; }

    var tabBtn = e.target.closest('.tab[data-t]');
    if (tabBtn) {
      tab = tabBtn.getAttribute('data-t');
      filt = 'all';
      document.querySelectorAll('.tab').forEach(function(b) {
        b.classList.toggle('on', b.getAttribute('data-t') === tab);
      });
      render();
      return;
    }
  });

  $('fg-sb').addEventListener('input', function() { render(); });
  $('fg-hideTaken').addEventListener('change', function() { savePrefs(); render(); });

  $('fg-export').addEventListener('click', exportTaken);
  $('fg-import').addEventListener('click', function() { $('fg-file-input').click(); });
  $('fg-file-input').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
      importTaken(e.target.files[0]);
      e.target.value = '';
    }
  });
  $('fg-clear-taken').addEventListener('click', function() {
    if (Object.keys(taken).length === 0) {
      showToast('Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑƒĞ¶Ğµ Ğ¿ÑƒÑÑ‚', 'info');
      return;
    }
    if (confirm('ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€? (' + Object.keys(taken).length + ' ÑˆÑ‚.)')) {
      taken = {};
      saveTaken();
      updateTakenCount();
      render();
      showToast('ğŸ—‘ï¸ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½', 'info');
    }
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INIT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  loadTaken();
  loadPrefs();
  $('fg-ut').textContent = new Date().toLocaleString('ru-RU');
  updateTakenCount();

  // 1) Show skeleton loading
  $('fg-ct').innerHTML = skeletonHTML();

  // 2) Show fallback immediately
  games = FALLBACK.map(norm);
  showBadge('fallback');
  render();

  // 3) Check cache
  var cached = cacheGet();
  if (cached && cached.length > 0) {
    games = cached.map(norm);
    showBadge('cache');
    render();
  }

  // 4) Fetch live data
  var pGP = fetchGP().catch(function() { return []; });
  var pEpic = fetchEpic().catch(function() { return []; });

  Promise.all([pGP, pEpic]).then(function(res) {
    var gp = res[0] || [];
    var epic = res[1] || [];
    var fb = FALLBACK.map(norm).filter(isActuallyFree);

    if (gp.length > 0 || epic.length > 0) {
      games = mergeGames(epic, gp, fb);
      showBadge('live');
      cacheSet(games);
      showToast('âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ â€” ' + games.length + ' Ğ¸Ğ³Ñ€', 'success');
    }

    loading = false;
    $('fg-ut').textContent = new Date().toLocaleString('ru-RU');
    render();
  });

  // Update timers every minute
  setInterval(render, 60000);

})();
</script>

</body>
</html>
